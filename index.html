<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="description" content="Castle Defense 3D - An epic tower defense game. Build towers, defend your castle against waves of enemies!">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <title>Castle Defense 3D - Ultimate Tower Defense</title>
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { touch-action: manipulation; overscroll-behavior: none; }
    body {
      min-height: 100vh; min-height: 100dvh;
      background: linear-gradient(180deg, #0a0a15 0%, #1a1a2e 30%, #16213e 70%, #0f0f23 100%);
      font-family: 'Cinzel', serif; color: #e8d5b7; overflow-x: hidden;
      -webkit-user-select: none; user-select: none;
    }
    .medieval { font-family: 'MedievalSharp', cursive; }

    .bg-stars {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
      background:
        radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 40% 70%, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 60% 50%, rgba(255,255,255,0.5), transparent),
        radial-gradient(1px 1px at 80% 10%, rgba(255,255,255,0.8), transparent),
        radial-gradient(2px 2px at 15% 65%, rgba(255,220,150,0.9), transparent);
      animation: twinkle 4s ease-in-out infinite;
    }
    @keyframes twinkle { 0%, 100% { opacity: 0.8; } 50% { opacity: 0.4; } }

    .screen { min-height: 100vh; min-height: 100dvh; display: flex; align-items: center; justify-content: center; padding: 1rem; position: relative; z-index: 10; }
    .screen.hidden { display: none !important; }
    .menu-content { text-align: center; animation: floatIn 0.6s ease-out; width: 100%; max-width: 500px; }
    @keyframes floatIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .game-title {
      font-size: clamp(2.5rem, 10vw, 4rem); font-weight: 900; font-family: 'MedievalSharp', cursive; color: #ffd700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.6), 0 4px 8px rgba(0, 0, 0, 0.9), 3px 3px 0 #8b4513;
      margin-bottom: 0.25rem; letter-spacing: 4px;
    }
    .game-subtitle { font-size: clamp(1.2rem, 5vw, 1.8rem); color: #cd853f; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8); letter-spacing: 6px; margin-bottom: 1.5rem; }

    .resource-display {
      display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1.5rem;
      background: rgba(0,0,0,0.4); padding: 0.6rem 1rem; border-radius: 8px; border: 2px solid #5d3a1a;
    }
    .resource-item { text-align: center; min-width: 60px; }
    .resource-icon { font-size: 1.2rem; }
    .resource-value { font-size: 1rem; font-family: 'MedievalSharp', cursive; color: #ffd700; }
    .resource-label { font-size: 0.5rem; color: #a89070; letter-spacing: 1px; }

    .menu-buttons { display: flex; flex-direction: column; gap: 0.6rem; align-items: center; }
    .menu-btn {
      padding: 0.8rem 2rem; min-width: 220px; width: 100%; max-width: 280px;
      background: linear-gradient(180deg, #8b4513 0%, #5d3a1a 50%, #3d2510 100%);
      border: 3px solid #ffd700; border-radius: 6px; color: #ffd700;
      font-weight: 700; font-size: clamp(0.9rem, 3vw, 1rem); font-family: 'MedievalSharp', cursive;
      cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 2px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }
    .menu-btn:hover, .menu-btn:active { background: linear-gradient(180deg, #a0522d 0%, #8b4513 50%, #5d3a1a 100%); transform: scale(1.02); }
    .menu-btn.secondary { background: linear-gradient(180deg, #2a4a6a 0%, #1a3a5a 50%, #0a2a4a 100%); border-color: #4a9fff; color: #8ac4ff; }
    .menu-btn.shop { background: linear-gradient(180deg, #6a2a6a 0%, #4a1a4a 50%, #2a0a2a 100%); border-color: #e040fb; color: #f0a0ff; }

    /* Shop Screen */
    #shop-screen { flex-direction: column; padding: 0.75rem; overflow-y: auto; }
    .shop-header { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 900px; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem; }
    .shop-title { font-size: clamp(1.2rem, 4vw, 1.8rem); font-family: 'MedievalSharp', cursive; color: #e040fb; }
    .back-btn { padding: 0.4rem 1rem; background: linear-gradient(180deg, #6a3a1a 0%, #4a2a10 100%); border: 2px solid #cd853f; border-radius: 4px; color: #ffd700; font-family: 'MedievalSharp', cursive; cursor: pointer; font-size: 0.8rem; }

    .shop-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(min(100%, 260px), 1fr)); gap: 0.75rem; max-width: 900px; width: 100%; }
    .shop-item {
      background: linear-gradient(180deg, rgba(80,40,80,0.3) 0%, rgba(40,20,40,0.5) 100%);
      border: 3px solid #5a3a5a; border-radius: 10px; padding: 0.75rem;
      display: flex; flex-direction: column; align-items: center; transition: all 0.2s; position: relative;
    }
    .shop-item:active { transform: scale(0.98); }
    .shop-item.owned { border-color: #4caf50; background: linear-gradient(180deg, rgba(40,80,40,0.3) 0%, rgba(20,40,20,0.5) 100%); }
    .shop-item.owned::after { content: 'OWNED'; position: absolute; top: 5px; right: 5px; background: #4caf50; color: white; padding: 0.15rem 0.5rem; font-size: 0.5rem; border-radius: 3px; }
    .shop-item-icon { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 0.4rem; }
    .shop-item-name { font-family: 'MedievalSharp', cursive; font-size: 1rem; color: #ffd700; }
    .shop-item-stats { font-size: 0.6rem; color: #a89070; margin-bottom: 0.3rem; text-align: center; }
    .shop-item-desc { font-size: 0.55rem; color: #c090c0; text-align: center; margin-bottom: 0.5rem; }
    .shop-item-price { display: flex; align-items: center; gap: 0.4rem; font-family: 'MedievalSharp', cursive; font-size: 0.9rem; }
    .price-gold { color: #ffd700; }
    .price-gems { color: #e040fb; }
    .buy-btn { margin-top: 0.5rem; padding: 0.4rem 1.5rem; background: linear-gradient(180deg, #6a2a6a 0%, #4a1a4a 100%); border: 2px solid #e040fb; border-radius: 4px; color: #f0a0ff; font-family: 'MedievalSharp', cursive; cursor: pointer; font-size: 0.8rem; }
    .buy-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .buy-btn.owned { background: #2e7d32; border-color: #4caf50; color: #a5d6a7; }

    /* Town Screen */
    #town-screen { flex-direction: column; padding: 0.75rem; overflow-y: auto; }
    .town-header { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 700px; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem; }
    .town-title { font-size: clamp(1.2rem, 4vw, 1.8rem); font-family: 'MedievalSharp', cursive; color: #ffd700; }
    .town-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 0.5rem; max-width: 700px; width: 100%; }
    .town-plot {
      aspect-ratio: 1; background: linear-gradient(135deg, #1a3a1a 0%, #0d260d 100%);
      border: 2px solid #2a4a2a; border-radius: 6px; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; position: relative;
    }
    .town-plot:active { transform: scale(0.95); }
    .town-plot.empty .plot-icon { font-size: 1.5rem; opacity: 0.5; }
    .town-plot.empty .plot-label { font-size: 0.5rem; color: #6a8a6a; }
    .town-plot.built { background: linear-gradient(135deg, #2a2a1a 0%, #1a1a0d 100%); border-color: #8b7355; }
    .building-3d { position: relative; width: 50px; height: 50px; }
    .building-icon { font-size: 2rem; }
    .building-level { font-size: 0.5rem; color: #ffd700; background: rgba(0,0,0,0.6); padding: 1px 4px; border-radius: 2px; position: absolute; bottom: 2px; right: 2px; }
    .plot-info { position: absolute; bottom: 2px; left: 0; right: 0; text-align: center; }
    .plot-name { font-size: 0.45rem; color: #ffd700; }

    /* Modals */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 1rem; }
    .modal-overlay.hidden { display: none; }
    .modal { background: linear-gradient(180deg, #2a1a0a 0%, #1a0f05 100%); border: 3px solid #8b4513; border-radius: 10px; padding: 1rem; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto; }
    .modal-title { font-size: 1.2rem; font-family: 'MedievalSharp', cursive; color: #ffd700; text-align: center; margin-bottom: 0.75rem; }
    .building-options { display: flex; flex-direction: column; gap: 0.4rem; }
    .building-option { display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem; background: rgba(100,60,20,0.3); border: 2px solid #5d3a1a; border-radius: 5px; cursor: pointer; }
    .building-option:active { background: rgba(140,80,30,0.4); }
    .building-option.disabled { opacity: 0.5; cursor: not-allowed; }
    .building-option-icon { font-size: 1.5rem; width: 35px; text-align: center; }
    .building-option-info { flex: 1; }
    .building-option-name { font-family: 'MedievalSharp', cursive; color: #ffd700; font-size: 0.85rem; }
    .building-option-desc { font-size: 0.55rem; color: #a89070; }
    .building-option-cost { font-size: 0.7rem; color: #ffd700; }
    .modal-close { display: block; width: 100%; margin-top: 0.75rem; padding: 0.5rem; background: linear-gradient(180deg, #4a2a1a 0%, #3a1a0a 100%); border: 2px solid #6d3a1a; border-radius: 4px; color: #cd853f; font-family: 'MedievalSharp', cursive; cursor: pointer; }
    .upgrade-info { text-align: center; margin-bottom: 0.75rem; }
    .upgrade-icon { font-size: 2rem; margin-bottom: 0.4rem; }
    .upgrade-current { font-size: 0.65rem; color: #a89070; }
    .upgrade-bonus { font-size: 0.75rem; color: #90ee90; margin: 0.3rem 0; }
    .upgrade-btn { display: block; width: 100%; padding: 0.5rem; background: linear-gradient(180deg, #2e7d32 0%, #1b5e20 100%); border: 2px solid #4caf50; border-radius: 4px; color: #fff; font-family: 'MedievalSharp', cursive; cursor: pointer; }
    .upgrade-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .demolish-btn { display: block; width: 100%; padding: 0.3rem; margin-top: 0.3rem; background: linear-gradient(180deg, #8b0000 0%, #5a0000 100%); border: 2px solid #dc143c; border-radius: 4px; color: #ff6b6b; font-family: 'MedievalSharp', cursive; cursor: pointer; font-size: 0.7rem; }

    /* Game Screen */
    #game-screen { padding: 0.5rem; flex-direction: column; align-items: center; overflow: hidden; }
    .game-header { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 900px; margin-bottom: 0.4rem; flex-wrap: wrap; gap: 0.3rem; }
    .stats-container { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .stat-box { background: linear-gradient(180deg, rgba(139, 69, 19, 0.4) 0%, rgba(20, 10, 5, 0.7) 100%); border: 2px solid; border-radius: 4px; padding: 0.2rem 0.4rem; }
    .stat-box.gold { border-color: #ffd700; }
    .stat-box.health { border-color: #dc143c; }
    .stat-box.wave { border-color: #9370db; }
    .stat-label { font-size: 0.4rem; letter-spacing: 1px; }
    .stat-label.gold-text { color: #ffd700; }
    .stat-label.red { color: #ff6b6b; }
    .stat-label.purple { color: #b19cd9; }
    .stat-value { font-size: 0.9rem; font-weight: 700; font-family: 'MedievalSharp', cursive; }
    .stat-value.gold-text { color: #ffd700; }
    .stat-value.red { color: #dc143c; }
    .stat-value.purple { color: #9370db; }
    .score-display { text-align: right; }
    .score-label { font-size: 0.4rem; color: #cd853f; }
    .score-value { font-size: 0.85rem; font-family: 'MedievalSharp', cursive; color: #ffd700; }

    .game-main { display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap; width: 100%; }
    .game-left { display: flex; flex-direction: column; align-items: center; }

    .grid-container { transform-style: preserve-3d; transform: rotateX(50deg); touch-action: none; }
    #game-grid {
      position: relative; display: grid; border: 3px solid #2a1a0a; border-radius: 3px;
      background: linear-gradient(135deg, #1a0f05 0%, #2d1f0f 100%); transform-style: preserve-3d;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8);
    }
    .grid-cell { width: var(--cell-size, 36px); height: var(--cell-size, 36px); border: 1px solid rgba(60, 40, 20, 0.4); position: relative; transform-style: preserve-3d; transition: all 0.1s; }
    .grid-cell.path { background: linear-gradient(135deg, #3d2d1f 0%, #2a1f15 100%); transform: translateZ(-4px); }
    .grid-cell.empty { background: linear-gradient(135deg, #1a4d1a 0%, #0d260d 100%); cursor: pointer; }
    .grid-cell.empty:hover, .grid-cell.empty:active { background: linear-gradient(135deg, #2a6d2a 0%, #1a4d1a 100%); transform: translateZ(3px); }
    .grid-cell.empty.can-place:hover, .grid-cell.empty.can-place:active { box-shadow: 0 0 10px rgba(255, 215, 0, 0.6); }
    .spawn-marker { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: #ff4444; font-size: 0.3rem; font-family: 'MedievalSharp', cursive; }
    .core-marker { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transform: translateZ(6px); }

    /* Tower 3D Models */
    .tower-3d { position: absolute; bottom: 1px; left: 50%; transform: translateX(-50%) translateZ(10px); transition: transform 0.15s; }
    .tower-3d:hover { transform: translateX(-50%) translateZ(16px) scale(1.08); }
    .tower-archer { width: 18px; height: 26px; }
    .tower-archer .t-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 16px; height: 20px; background: linear-gradient(90deg, #5d4037 0%, #8d6e63 50%, #5d4037 100%); border-radius: 2px; }
    .tower-archer .t-roof { position: absolute; top: -3px; left: 50%; transform: translateX(-50%); width: 20px; height: 6px; background: #2e7d32; clip-path: polygon(50% 0%, 100% 100%, 0% 100%); }
    .tower-wizard { width: 16px; height: 30px; }
    .tower-wizard .t-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 14px; height: 22px; background: linear-gradient(90deg, #4a148c 0%, #7b1fa2 50%, #4a148c 100%); border-radius: 2px 2px 0 0; }
    .tower-wizard .t-roof { position: absolute; top: -5px; left: 50%; transform: translateX(-50%); border-left: 9px solid transparent; border-right: 9px solid transparent; border-bottom: 8px solid #7b1fa2; }
    .tower-wizard .t-orb { position: absolute; top: -7px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background: radial-gradient(circle, #fff, #e1bee7); border-radius: 50%; box-shadow: 0 0 6px #9c27b0; }
    .tower-frost { width: 18px; height: 28px; }
    .tower-frost .t-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 16px; height: 22px; background: linear-gradient(180deg, rgba(200,240,255,0.9) 0%, rgba(100,200,255,0.8) 100%); clip-path: polygon(50% 0%, 90% 30%, 100% 100%, 0% 100%, 10% 30%); box-shadow: 0 0 8px rgba(100,200,255,0.5); }
    .tower-cannon { width: 20px; height: 22px; }
    .tower-cannon .t-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 18px; height: 16px; background: linear-gradient(90deg, #5d5d5d 0%, #8a8a8a 50%, #5d5d5d 100%); border-radius: 2px; }
    .tower-cannon .t-barrel { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); width: 10px; height: 5px; background: #2a2a2a; border-radius: 2px; }
    .tower-dragon { width: 20px; height: 36px; }
    .tower-dragon .t-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 18px; height: 28px; background: linear-gradient(90deg, #4a1a1a 0%, #8b2a2a 50%, #4a1a1a 100%); clip-path: polygon(20% 100%, 5% 50%, 50% 0%, 95% 50%, 80% 100%); box-shadow: 0 0 8px rgba(255,100,50,0.4); }
    .tower-dragon .t-flame { position: absolute; top: -6px; left: 50%; transform: translateX(-50%); width: 7px; height: 10px; background: linear-gradient(0deg, #ff5722, #ffeb3b); border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; animation: flame 0.2s infinite alternate; }
    @keyframes flame { from { transform: translateX(-50%) scaleY(1); } to { transform: translateX(-50%) scaleY(1.1); } }
    .tower-lightning { width: 18px; height: 34px; }
    .tower-lightning .t-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 14px; height: 26px; background: linear-gradient(90deg, #37474f 0%, #78909c 50%, #37474f 100%); clip-path: polygon(30% 100%, 10% 60%, 50% 0%, 90% 60%, 70% 100%); }
    .tower-lightning .t-orb { position: absolute; top: -5px; left: 50%; transform: translateX(-50%); width: 7px; height: 7px; background: radial-gradient(circle, #fff, #ffeb3b); border-radius: 50%; box-shadow: 0 0 10px #ffeb3b; animation: electricPulse 0.3s infinite; }
    @keyframes electricPulse { 0%, 100% { box-shadow: 0 0 10px #ffeb3b; } 50% { box-shadow: 0 0 16px #ffc107; } }
    .tower-poison { width: 20px; height: 28px; }
    .tower-poison .t-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 18px; height: 20px; background: linear-gradient(90deg, #2a2a2a 0%, #4a4a4a 50%, #2a2a2a 100%); border-radius: 3px 3px 8px 8px; }
    .tower-poison .t-liquid { position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 12px; height: 10px; background: linear-gradient(180deg, #7cb342 0%, #33691e 100%); border-radius: 2px 2px 6px 6px; animation: bubble 0.8s infinite; }
    @keyframes bubble { 0%, 100% { transform: translateX(-50%) scaleY(1); } 50% { transform: translateX(-50%) scaleY(1.05); } }
    .tower-ballista { width: 22px; height: 24px; }
    .tower-ballista .t-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 20px; height: 14px; background: linear-gradient(90deg, #5d4037 0%, #8d6e63 50%, #5d4037 100%); border-radius: 2px; }
    .tower-ballista .t-bow { position: absolute; top: 1px; left: 50%; transform: translateX(-50%); width: 18px; height: 10px; border: 2px solid #3e2723; border-bottom: none; border-radius: 50% 50% 0 0; }
    .tower-mortar { width: 22px; height: 20px; }
    .tower-mortar .t-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 20px; height: 12px; background: linear-gradient(90deg, #4a4a4a 0%, #7a7a7a 50%, #4a4a4a 100%); border-radius: 2px; }
    .tower-mortar .t-tube { position: absolute; top: -1px; left: 50%; transform: translateX(-50%) rotate(-30deg); width: 8px; height: 12px; background: linear-gradient(90deg, #3a3a3a 0%, #5a5a5a 50%, #3a3a3a 100%); border-radius: 2px 2px 0 0; }
    .tower-tesla { width: 20px; height: 32px; }
    .tower-tesla .t-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 16px; height: 22px; background: linear-gradient(90deg, #1a237e 0%, #3f51b5 50%, #1a237e 100%); border-radius: 2px; }
    .tower-tesla .t-coil { position: absolute; top: -6px; left: 50%; transform: translateX(-50%); width: 10px; height: 10px; background: radial-gradient(circle, #fff 0%, #2196f3 50%, #0d47a1 100%); border-radius: 50%; box-shadow: 0 0 10px #2196f3; animation: teslaGlow 0.2s infinite alternate; }
    @keyframes teslaGlow { from { box-shadow: 0 0 10px #2196f3; } to { box-shadow: 0 0 18px #0d47a1; } }
    .tower-range { position: absolute; border-radius: 50%; opacity: 0.06; pointer-events: none; border: 2px dashed currentColor; }

    #enemies-layer, #projectiles-layer, #effects-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; transform-style: preserve-3d; }
    .enemy-3d { position: absolute; transform: translate(-50%, -50%) translateZ(14px); transition: left 0.05s linear, top 0.05s linear; }
    .enemy-3d.slowed { filter: brightness(1.3) saturate(0.7); }
    .enemy-3d.frozen { filter: brightness(1.5) hue-rotate(180deg); }
    .enemy-3d.burning { animation: burn 0.2s infinite alternate; }
    @keyframes burn { from { filter: brightness(1); } to { filter: brightness(1.3) sepia(0.4); } }
    .enemy-model { position: relative; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .enemy-health-bar { position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 18px; height: 2px; background: #1a1a1a; border-radius: 1px; overflow: hidden; }
    .enemy-health-fill { height: 100%; transition: width 0.1s; }
    .projectile { position: absolute; border-radius: 50%; transform: translate(-50%, -50%) translateZ(18px); }
    .effect { position: absolute; transform: translate(-50%, -50%) translateZ(22px); font-size: 0.9rem; pointer-events: none; }

    .skills-bar { display: flex; gap: 0.3rem; margin-top: 0.5rem; justify-content: center; }
    .skill-button { width: 36px; height: 36px; border-radius: 5px; border: 2px solid #5d3a1a; background: linear-gradient(180deg, rgba(60,30,10,0.8) 0%, rgba(30,15,5,0.9) 100%); cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s; position: relative; }
    .skill-button:hover:not(:disabled), .skill-button:active:not(:disabled) { border-color: #ffd700; transform: scale(1.05); }
    .skill-button:disabled { opacity: 0.5; }
    .skill-cooldown { position: absolute; font-size: 0.5rem; color: #ffd700; font-family: 'MedievalSharp', cursive; }
    .skill-key { position: absolute; bottom: 1px; right: 2px; font-size: 0.35rem; color: #888; }

    .sidebar { width: 180px; flex-shrink: 0; }
    .sidebar-title { color: #ffd700; font-size: 0.5rem; letter-spacing: 1px; margin-bottom: 0.3rem; font-family: 'MedievalSharp', cursive; }
    .tower-buttons { display: flex; flex-direction: column; gap: 0.2rem; max-height: 200px; overflow-y: auto; }
    .tower-buttons::-webkit-scrollbar { width: 3px; }
    .tower-buttons::-webkit-scrollbar-thumb { background: #5d3a1a; border-radius: 2px; }
    .tower-button { width: 100%; padding: 0.25rem 0.3rem; border-radius: 3px; text-align: left; background: linear-gradient(180deg, rgba(80,40,15,0.3) 0%, rgba(30,15,5,0.5) 100%); border: 2px solid #4d2a1a; cursor: pointer; transition: all 0.15s; color: #e8d5b7; }
    .tower-button:active:not(:disabled) { background: linear-gradient(180deg, rgba(120,60,25,0.4) 0%, rgba(50,25,10,0.6) 100%); }
    .tower-button:disabled { opacity: 0.4; }
    .tower-button.selected { box-shadow: 0 0 0 2px currentColor; border-color: currentColor; }
    .tower-button.locked { background: rgba(50,50,50,0.5); border-color: #444; }
    .tower-button-header { display: flex; align-items: center; gap: 0.2rem; }
    .tower-button-name { font-weight: 700; font-family: 'MedievalSharp', cursive; font-size: 0.6rem; }
    .tower-button-cost { margin-left: auto; font-size: 0.55rem; color: #ffd700; }
    .tower-button-lock { margin-left: auto; font-size: 0.5rem; color: #888; }
    .wave-control { margin-top: 0.4rem; }
    .wave-button { width: 100%; padding: 0.3rem; border: 2px solid; border-radius: 3px; font-weight: 700; font-family: 'MedievalSharp', cursive; cursor: pointer; font-size: 0.65rem; }
    .wave-button.start { background: linear-gradient(180deg, #8b0000 0%, #4a0000 100%); border-color: #dc143c; color: #ffd700; }
    .wave-button.in-progress { background: linear-gradient(180deg, #4a3000 0%, #2a1a00 100%); border-color: #ffd700; color: #ffd700; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .bonuses-display { margin-top: 0.3rem; padding: 0.25rem; background: rgba(0,0,0,0.3); border: 1px solid #3d2510; border-radius: 3px; }
    .bonuses-title { font-size: 0.4rem; color: #cd853f; margin-bottom: 0.15rem; }
    .bonus-item { font-size: 0.4rem; color: #90ee90; }
    .quit-btn { margin-top: 0.4rem; width: 100%; padding: 0.25rem; background: linear-gradient(180deg, #4a2a1a 0%, #3a1a0a 100%); border: 2px solid #6d3a1a; border-radius: 3px; color: #cd853f; font-family: 'MedievalSharp', cursive; cursor: pointer; font-size: 0.55rem; }

    .game-over-title { font-size: clamp(2rem, 8vw, 3rem); font-family: 'MedievalSharp', cursive; margin-bottom: 0.75rem; }
    .game-over-title.won { color: #ffd700; }
    .game-over-title.lost { color: #dc143c; }
    .game-over-score { font-size: 1.1rem; color: #cd853f; margin-bottom: 0.4rem; }
    .game-over-stats { font-size: 0.9rem; color: #a89070; margin-bottom: 0.4rem; }
    .game-over-reward { font-size: 0.95rem; color: #ffd700; margin-bottom: 1rem; }

    .hidden { display: none !important; }

    /* Mobile adjustments */
    @media (max-width: 700px) {
      .game-main { flex-direction: column; }
      .sidebar { width: 100%; max-width: 400px; }
      .tower-buttons { flex-direction: row; flex-wrap: wrap; max-height: none; }
      .tower-button { width: calc(50% - 0.1rem); }
      .skills-bar { order: -1; }
    }
    @media (max-width: 400px) {
      :root { --cell-size: 28px; }
    }
  </style>
</head>
<body>
  <div class="bg-stars"></div>

  <!-- Menu Screen -->
  <div id="menu-screen" class="screen">
    <div class="menu-content">
      <h1 class="game-title">CASTLE</h1>
      <h2 class="game-subtitle">DEFENSE 3D</h2>
      <div class="resource-display">
        <div class="resource-item"><div class="resource-icon">ü™ô</div><div class="resource-value" id="menu-gold">500</div><div class="resource-label">GOLD</div></div>
        <div class="resource-item"><div class="resource-icon">üíé</div><div class="resource-value" id="menu-gems">0</div><div class="resource-label">GEMS</div></div>
        <div class="resource-item"><div class="resource-icon">‚≠ê</div><div class="resource-value" id="menu-level">1</div><div class="resource-label">LEVEL</div></div>
      </div>
      <div class="menu-buttons">
        <button class="menu-btn" onclick="startGame()">BATTLE</button>
        <button class="menu-btn secondary" onclick="showTown()">TOWN</button>
        <button class="menu-btn shop" onclick="showShop()">SHOP</button>
      </div>
    </div>
  </div>

  <!-- Shop Screen -->
  <div id="shop-screen" class="screen hidden">
    <div class="shop-header">
      <h2 class="shop-title">Tower Shop</h2>
      <div class="resource-display" style="margin:0;padding:0.3rem 0.8rem;"><div class="resource-item"><div class="resource-icon">ü™ô</div><div class="resource-value" id="shop-gold">500</div></div><div class="resource-item"><div class="resource-icon">üíé</div><div class="resource-value" id="shop-gems">0</div></div></div>
      <button class="back-btn" onclick="showMenu()">Back</button>
    </div>
    <div class="shop-container" id="shop-container"></div>
  </div>

  <!-- Town Screen -->
  <div id="town-screen" class="screen hidden">
    <div class="town-header">
      <h2 class="town-title">Your Kingdom</h2>
      <div class="resource-display" style="margin:0;padding:0.3rem 0.8rem;"><div class="resource-item"><div class="resource-icon">ü™ô</div><div class="resource-value" id="town-gold">500</div></div></div>
      <button class="back-btn" onclick="showMenu()">Back</button>
    </div>
    <div class="town-container" id="town-grid"></div>
  </div>

  <!-- Build Modal -->
  <div id="build-modal" class="modal-overlay hidden">
    <div class="modal"><h3 class="modal-title">Build Structure</h3><div class="building-options" id="building-options"></div><button class="modal-close" onclick="closeBuildModal()">Cancel</button></div>
  </div>

  <!-- Upgrade Modal -->
  <div id="upgrade-modal" class="modal-overlay hidden">
    <div class="modal"><h3 class="modal-title" id="upgrade-title">Upgrade</h3><div class="upgrade-info"><div class="upgrade-icon" id="upgrade-icon"></div><div class="upgrade-current" id="upgrade-current"></div><div class="upgrade-bonus" id="upgrade-next-bonus"></div></div><button class="upgrade-btn" id="upgrade-btn" onclick="upgradeBuilding()">Upgrade</button><button class="demolish-btn" onclick="demolishBuilding()">Demolish (50%)</button><button class="modal-close" onclick="closeUpgradeModal()">Close</button></div>
  </div>

  <!-- Game Screen -->
  <div id="game-screen" class="screen hidden">
    <div class="game-header">
      <div class="stats-container">
        <div class="stat-box gold"><div class="stat-label gold-text">GOLD</div><div class="stat-value gold-text" id="credits-display">ü™ô 200</div></div>
        <div class="stat-box health"><div class="stat-label red">CASTLE</div><div class="stat-value red" id="lives-display">‚ù§Ô∏è 25</div></div>
        <div class="stat-box wave"><div class="stat-label purple">WAVE</div><div class="stat-value purple" id="wave-display">1/15</div></div>
      </div>
      <div class="score-display"><div class="score-label">SCORE</div><div class="score-value" id="score-display">0</div></div>
    </div>
    <div class="game-main">
      <div class="game-left">
        <div class="grid-container"><div id="game-grid"></div></div>
        <div class="skills-bar" id="skills-bar"></div>
      </div>
      <div class="sidebar">
        <div class="sidebar-title">BUILD DEFENSES</div>
        <div class="tower-buttons" id="tower-buttons"></div>
        <div class="wave-control"><button class="wave-button start" id="wave-button" onclick="startWave()">FACE WAVE 1</button></div>
        <div class="bonuses-display" id="bonuses-display"></div>
        <button class="quit-btn" onclick="quitGame()">Quit</button>
      </div>
    </div>
  </div>

  <!-- Game Over Screen -->
  <div id="game-over-screen" class="screen hidden">
    <div class="menu-content">
      <h1 class="game-over-title" id="game-over-title">VICTORY!</h1>
      <p class="game-over-score" id="game-over-score">Score: 0</p>
      <p class="game-over-stats" id="game-over-stats">Wave 1 | Kills: 0</p>
      <p class="game-over-reward" id="game-over-reward">+0 Gold, +0 Gems</p>
      <button class="menu-btn" onclick="resetGame()">PLAY AGAIN</button>
      <button class="menu-btn secondary" style="margin-top:0.5rem;" onclick="backToMenu()">MAIN MENU</button>
    </div>
  </div>

  <script>
    // ============== SAVE DATA ==============
    let saveData = { gold: 500, gems: 0, level: 1, xp: 0, unlockedTowers: ['archer','wizard','frost','cannon'], townBuildings: {}, gamesPlayed: 0 };
    function loadSave() { const s = localStorage.getItem('castleDefense3DSave'); if (s) saveData = JSON.parse(s); }
    function saveToDisk() { localStorage.setItem('castleDefense3DSave', JSON.stringify(saveData)); }

    // ============== TOWERS ==============
    const TOWERS = {
      archer: { name: 'Archer', cost: 35, damage: 12, range: 2.5, attackSpeed: 600, color: '#7cfc00', shopCost: 0, desc: 'Fast arrows' },
      wizard: { name: 'Wizard', cost: 70, damage: 30, range: 2.5, attackSpeed: 1200, color: '#9370db', shopCost: 0, desc: 'Magic bolts' },
      frost: { name: 'Frost', cost: 80, damage: 8, range: 2, attackSpeed: 500, color: '#00bfff', slow: 0.5, shopCost: 0, desc: 'Slows enemies' },
      cannon: { name: 'Cannon', cost: 100, damage: 45, range: 2.5, attackSpeed: 1800, color: '#696969', aoe: true, aoeRadius: 1.5, shopCost: 0, desc: 'Splash damage' },
      dragon: { name: 'Dragon', cost: 150, damage: 35, range: 2.5, attackSpeed: 1600, color: '#ff4500', aoe: true, aoeRadius: 2, burn: { damage: 5, duration: 2000 }, shopCost: 200, desc: 'Burns enemies' },
      lightning: { name: 'Lightning', cost: 160, damage: 50, range: 3, attackSpeed: 2200, color: '#ffff00', chain: 3, shopCost: 250, desc: 'Chain lightning' },
      poison: { name: 'Poison', cost: 90, damage: 5, range: 2, attackSpeed: 700, color: '#7cb342', poison: { damage: 4, duration: 3000 }, shopCost: 150, desc: 'Poison damage' },
      ballista: { name: 'Ballista', cost: 85, damage: 40, range: 4, attackSpeed: 2000, color: '#8b4513', shopCost: 180, desc: 'Long range' },
      mortar: { name: 'Mortar', cost: 130, damage: 60, range: 3.5, attackSpeed: 2500, color: '#5d5d5d', aoe: true, aoeRadius: 2, shopCost: 300, desc: 'Heavy splash' },
      tesla: { name: 'Tesla', cost: 180, damage: 70, range: 2.5, attackSpeed: 2800, color: '#2196f3', chain: 4, shopCost: 400, shopGems: 5, desc: 'Multi-chain' },
    };

    const TOWER_MODELS = {
      archer: `<div class="tower-3d tower-archer"><div class="t-body"></div><div class="t-roof"></div></div>`,
      wizard: `<div class="tower-3d tower-wizard"><div class="t-body"></div><div class="t-roof"></div><div class="t-orb"></div></div>`,
      frost: `<div class="tower-3d tower-frost"><div class="t-body"></div></div>`,
      cannon: `<div class="tower-3d tower-cannon"><div class="t-body"></div><div class="t-barrel"></div></div>`,
      dragon: `<div class="tower-3d tower-dragon"><div class="t-body"></div><div class="t-flame"></div></div>`,
      lightning: `<div class="tower-3d tower-lightning"><div class="t-body"></div><div class="t-orb"></div></div>`,
      poison: `<div class="tower-3d tower-poison"><div class="t-body"></div><div class="t-liquid"></div></div>`,
      ballista: `<div class="tower-3d tower-ballista"><div class="t-body"></div><div class="t-bow"></div></div>`,
      mortar: `<div class="tower-3d tower-mortar"><div class="t-body"></div><div class="t-tube"></div></div>`,
      tesla: `<div class="tower-3d tower-tesla"><div class="t-body"></div><div class="t-coil"></div></div>`,
    };

    // ============== ENEMIES ==============
    const ENEMIES = {
      peasant: { name: 'Peasant', health: 25, speed: 1.2, reward: 6, icon: 'üë§', type: 'normal' },
      footman: { name: 'Footman', health: 50, speed: 1, reward: 10, icon: '‚öîÔ∏è', type: 'normal' },
      archer: { name: 'Archer', health: 35, speed: 1.4, reward: 12, icon: 'üèπ', type: 'normal' },
      knight: { name: 'Knight', health: 120, speed: 0.6, reward: 20, icon: 'üõ°Ô∏è', type: 'normal' },
      cavalry: { name: 'Cavalry', health: 70, speed: 2, reward: 18, icon: 'üêé', type: 'normal' },
      darkKnight: { name: 'Dark Knight', health: 250, speed: 0.5, reward: 40, icon: 'üñ§', type: 'elite', armor: 0.3 },
      warlock: { name: 'Warlock', health: 100, speed: 0.8, reward: 35, icon: 'üîÆ', type: 'elite', shield: 40 },
      berserker: { name: 'Berserker', health: 180, speed: 1.5, reward: 38, icon: 'ü™ì', type: 'elite' },
      siege: { name: 'Siege Ram', health: 400, speed: 0.3, reward: 50, icon: 'ü™µ', type: 'elite', armor: 0.5 },
      champion: { name: 'Champion', health: 700, speed: 0.4, reward: 80, icon: 'üëë', type: 'boss', armor: 0.2 },
      necromancer: { name: 'Necromancer', health: 500, speed: 0.5, reward: 100, icon: 'üíÄ', type: 'boss' },
      dragon: { name: 'Dragon', health: 900, speed: 0.6, reward: 120, icon: 'üê≤', type: 'boss', armor: 0.3 },
    };

    // ============== SKILLS ==============
    const SKILLS = {
      fireball: { name: 'Meteor', icon: '‚òÑÔ∏è', cooldown: 18000, damage: 80, key: '1' },
      freeze: { name: 'Blizzard', icon: 'üå®Ô∏è', cooldown: 22000, duration: 3000, key: '2' },
      gold: { name: 'Tax', icon: 'üí∞', cooldown: 28000, amount: 80, key: '3' },
      heal: { name: 'Fortify', icon: 'üè•', cooldown: 40000, amount: 5, key: '4' },
    };

    // ============== TOWN BUILDINGS ==============
    const TOWN_BUILDINGS = {
      barracks: { name: 'Barracks', icon: '‚öîÔ∏è', cost: 100, maxLevel: 3, bonus: { startGold: 20 }, desc: '+20 gold/lvl' },
      blacksmith: { name: 'Blacksmith', icon: 'üî®', cost: 150, maxLevel: 3, bonus: { towerDamage: 0.05 }, desc: '+5% damage/lvl' },
      treasury: { name: 'Treasury', icon: 'üí∞', cost: 200, maxLevel: 3, bonus: { goldPerKill: 0.1 }, desc: '+10% gold/kill/lvl' },
      temple: { name: 'Temple', icon: '‚õ™', cost: 250, maxLevel: 3, bonus: { startLives: 2 }, desc: '+2 lives/lvl' },
      market: { name: 'Market', icon: 'üè™', cost: 175, maxLevel: 3, bonus: { towerDiscount: 0.05 }, desc: '-5% cost/lvl' },
      watchtower: { name: 'Watchtower', icon: 'üóº', cost: 300, maxLevel: 3, bonus: { towerRange: 0.05 }, desc: '+5% range/lvl' },
      farm: { name: 'Farm', icon: 'üåæ', cost: 125, maxLevel: 3, bonus: { waveBonus: 8 }, desc: '+8 gold/wave/lvl' }
    };

    const PATH = [{ x: 0, y: 5 }, { x: 2, y: 5 }, { x: 2, y: 2 }, { x: 5, y: 2 }, { x: 5, y: 8 }, { x: 8, y: 8 }, { x: 8, y: 4 }, { x: 11, y: 4 }, { x: 11, y: 6 }];
    const GRID_SIZE = 12, TICK_RATE = 50, MAX_WAVES = 15;
    let CELL_SIZE = 36;

    let credits, lives, wave, score, kills, towers, enemies, projectiles, effects, selectedTower, waveInProgress, skillCooldowns, gameLoopId, lastUpdate, townBonuses;
    let selectedPlot = null, selectedBuildingType = null;

    // ============== UTILITIES ==============
    function distance(x1, y1, x2, y2) { return Math.sqrt((x2-x1)**2 + (y2-y1)**2); }
    function isOnPath(x, y) { for (let i = 0; i < PATH.length - 1; i++) { const s = PATH[i], e = PATH[i+1]; if (s.x === e.x && x === s.x && y >= Math.min(s.y, e.y) && y <= Math.max(s.y, e.y)) return true; if (s.y === e.y && y === s.y && x >= Math.min(s.x, e.x) && x <= Math.max(s.x, e.x)) return true; } return false; }
    function getPositionOnPath(progress) { let totalLength = 0; const segments = []; for (let i = 0; i < PATH.length - 1; i++) { const dx = PATH[i+1].x - PATH[i].x, dy = PATH[i+1].y - PATH[i].y; segments.push({ start: PATH[i], end: PATH[i+1], length: Math.sqrt(dx*dx + dy*dy) }); totalLength += segments[i].length; } let targetDist = progress * totalLength, accumulated = 0; for (const seg of segments) { if (accumulated + seg.length >= targetDist) { const t = (targetDist - accumulated) / seg.length; return { x: seg.start.x + (seg.end.x - seg.start.x) * t, y: seg.start.y + (seg.end.y - seg.start.y) * t }; } accumulated += seg.length; } return PATH[PATH.length - 1]; }

    function getTownBonuses() {
      const bonuses = { startGold: 0, towerDamage: 0, goldPerKill: 0, startLives: 0, towerDiscount: 0, towerRange: 0, waveBonus: 0 };
      Object.values(saveData.townBuildings).forEach(b => { const def = TOWN_BUILDINGS[b.type]; Object.entries(def.bonus).forEach(([k, v]) => { bonuses[k] += v * b.level; }); });
      return bonuses;
    }

    // ============== SCREEN NAVIGATION ==============
    function showMenu() { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById('menu-screen').classList.remove('hidden'); updateMenuDisplay(); }
    function showShop() { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById('shop-screen').classList.remove('hidden'); renderShop(); }
    function showTown() { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById('town-screen').classList.remove('hidden'); renderTownGrid(); }
    function updateMenuDisplay() { document.getElementById('menu-gold').textContent = saveData.gold; document.getElementById('menu-gems').textContent = saveData.gems; document.getElementById('menu-level').textContent = saveData.level; }

    // ============== SHOP ==============
    function renderShop() {
      document.getElementById('shop-gold').textContent = saveData.gold;
      document.getElementById('shop-gems').textContent = saveData.gems;
      const container = document.getElementById('shop-container');
      container.innerHTML = '';
      Object.entries(TOWERS).forEach(([type, tower]) => {
        const owned = saveData.unlockedTowers.includes(type);
        const canAfford = saveData.gold >= tower.shopCost && saveData.gems >= (tower.shopGems || 0);
        const item = document.createElement('div');
        item.className = 'shop-item' + (owned ? ' owned' : '');
        item.innerHTML = `
          <div class="shop-item-icon">${TOWER_MODELS[type]}</div>
          <div class="shop-item-name">${tower.name}</div>
          <div class="shop-item-stats">DMG: ${tower.damage} | RNG: ${tower.range} | SPD: ${tower.attackSpeed}ms</div>
          <div class="shop-item-desc">${tower.desc}</div>
          <div class="shop-item-price">${tower.shopCost > 0 ? `<span class="price-gold">ü™ô${tower.shopCost}</span>` : ''}${tower.shopGems ? `<span class="price-gems">üíé${tower.shopGems}</span>` : ''}${tower.shopCost === 0 && !tower.shopGems ? '<span style="color:#4caf50">FREE</span>' : ''}</div>
          <button class="buy-btn${owned ? ' owned' : ''}" ${owned || !canAfford ? 'disabled' : ''} onclick="buyTower('${type}')">${owned ? 'Owned' : 'Buy'}</button>
        `;
        container.appendChild(item);
      });
    }
    function buyTower(type) {
      const tower = TOWERS[type];
      if (saveData.gold >= tower.shopCost && saveData.gems >= (tower.shopGems || 0) && !saveData.unlockedTowers.includes(type)) {
        saveData.gold -= tower.shopCost;
        saveData.gems -= tower.shopGems || 0;
        saveData.unlockedTowers.push(type);
        saveToDisk();
        renderShop();
      }
    }

    // ============== TOWN ==============
    function renderTownGrid() {
      document.getElementById('town-gold').textContent = saveData.gold;
      const grid = document.getElementById('town-grid');
      grid.innerHTML = '';
      for (let i = 0; i < 16; i++) {
        const plot = document.createElement('div');
        const building = saveData.townBuildings[i];
        plot.className = 'town-plot' + (building ? ' built' : ' empty');
        if (building) {
          const def = TOWN_BUILDINGS[building.type];
          plot.innerHTML = `<div class="building-3d"><div class="building-icon">${def.icon}</div><span class="building-level">Lv.${building.level}</span></div><div class="plot-info"><div class="plot-name">${def.name}</div></div>`;
          plot.onclick = () => openUpgradeModal(i);
        } else {
          plot.innerHTML = '<div class="plot-icon">+</div><div class="plot-label">Build</div>';
          plot.onclick = () => openBuildModal(i);
        }
        grid.appendChild(plot);
      }
    }
    function openBuildModal(plotIndex) {
      selectedPlot = plotIndex;
      const options = document.getElementById('building-options');
      options.innerHTML = '';
      Object.entries(TOWN_BUILDINGS).forEach(([type, b]) => {
        const canAfford = saveData.gold >= b.cost;
        const opt = document.createElement('div');
        opt.className = 'building-option' + (!canAfford ? ' disabled' : '');
        opt.innerHTML = `<div class="building-option-icon">${b.icon}</div><div class="building-option-info"><div class="building-option-name">${b.name}</div><div class="building-option-desc">${b.desc}</div></div><div class="building-option-cost">ü™ô${b.cost}</div>`;
        if (canAfford) opt.onclick = () => buildBuilding(type);
        options.appendChild(opt);
      });
      document.getElementById('build-modal').classList.remove('hidden');
    }
    function closeBuildModal() { document.getElementById('build-modal').classList.add('hidden'); }
    function buildBuilding(type) {
      const b = TOWN_BUILDINGS[type];
      if (saveData.gold >= b.cost && selectedPlot !== null) {
        saveData.gold -= b.cost;
        saveData.townBuildings[selectedPlot] = { type, level: 1 };
        saveToDisk();
        closeBuildModal();
        renderTownGrid();
      }
    }
    function openUpgradeModal(plotIndex) {
      selectedPlot = plotIndex;
      const building = saveData.townBuildings[plotIndex];
      const def = TOWN_BUILDINGS[building.type];
      document.getElementById('upgrade-title').textContent = def.name;
      document.getElementById('upgrade-icon').textContent = def.icon;
      document.getElementById('upgrade-current').textContent = `Level ${building.level}/${def.maxLevel}`;
      const nextBonus = Object.entries(def.bonus).map(([k, v]) => `+${(v * (building.level + 1) * 100).toFixed(0)}% ${k}`).join(', ');
      document.getElementById('upgrade-next-bonus').textContent = building.level < def.maxLevel ? `Next: ${nextBonus}` : 'MAX LEVEL';
      const cost = Math.floor(def.cost * (building.level + 1) * 0.6);
      const btn = document.getElementById('upgrade-btn');
      btn.textContent = building.level < def.maxLevel ? `Upgrade (ü™ô${cost})` : 'Max Level';
      btn.disabled = building.level >= def.maxLevel || saveData.gold < cost;
      document.getElementById('upgrade-modal').classList.remove('hidden');
    }
    function closeUpgradeModal() { document.getElementById('upgrade-modal').classList.add('hidden'); }
    function upgradeBuilding() {
      const building = saveData.townBuildings[selectedPlot];
      const def = TOWN_BUILDINGS[building.type];
      const cost = Math.floor(def.cost * (building.level + 1) * 0.6);
      if (building.level < def.maxLevel && saveData.gold >= cost) {
        saveData.gold -= cost;
        building.level++;
        saveToDisk();
        closeUpgradeModal();
        renderTownGrid();
      }
    }
    function demolishBuilding() {
      const building = saveData.townBuildings[selectedPlot];
      const def = TOWN_BUILDINGS[building.type];
      const refund = Math.floor(def.cost * building.level * 0.5);
      saveData.gold += refund;
      delete saveData.townBuildings[selectedPlot];
      saveToDisk();
      closeUpgradeModal();
      renderTownGrid();
    }

    // ============== GAME ==============
    function initGame() {
      townBonuses = getTownBonuses();
      credits = 180 + townBonuses.startGold;
      lives = 25 + townBonuses.startLives;
      wave = 1; score = 0; kills = 0;
      towers = []; enemies = []; projectiles = []; effects = [];
      selectedTower = null; waveInProgress = false;
      skillCooldowns = {}; Object.keys(SKILLS).forEach(s => skillCooldowns[s] = 0);
      updateCellSize();
    }

    function updateCellSize() {
      const viewportWidth = window.innerWidth;
      if (viewportWidth < 400) CELL_SIZE = 28;
      else if (viewportWidth < 600) CELL_SIZE = 32;
      else CELL_SIZE = 36;
      document.documentElement.style.setProperty('--cell-size', CELL_SIZE + 'px');
    }

    function updateUI() {
      document.getElementById('credits-display').textContent = `ü™ô ${credits}`;
      document.getElementById('lives-display').textContent = `‚ù§Ô∏è ${lives}`;
      document.getElementById('wave-display').textContent = `${wave}/${MAX_WAVES}`;
      document.getElementById('score-display').textContent = score.toLocaleString();
      Object.keys(TOWERS).forEach(type => {
        const btn = document.getElementById(`tower-btn-${type}`);
        if (btn) {
          const cost = Math.floor(TOWERS[type].cost * (1 - townBonuses.towerDiscount));
          const unlocked = saveData.unlockedTowers.includes(type);
          btn.disabled = !unlocked || credits < cost;
          btn.classList.toggle('selected', selectedTower === type);
          btn.classList.toggle('locked', !unlocked);
          btn.style.borderColor = selectedTower === type ? TOWERS[type].color : '';
        }
      });
      const waveBtn = document.getElementById('wave-button');
      waveBtn.className = waveInProgress ? 'wave-button in-progress' : 'wave-button start';
      waveBtn.textContent = waveInProgress ? 'BATTLE!' : `WAVE ${wave}`;
      Object.entries(SKILLS).forEach(([key, skill]) => {
        const btn = document.getElementById(`skill-${key}`);
        if (btn) {
          const remaining = Math.max(0, skillCooldowns[key] - Date.now());
          btn.disabled = remaining > 0;
          const cd = btn.querySelector('.skill-cooldown');
          if (cd) cd.textContent = remaining > 0 ? Math.ceil(remaining / 1000) + 's' : '';
        }
      });
      const bonusesEl = document.getElementById('bonuses-display');
      if (bonusesEl) {
        let bonusText = '';
        if (townBonuses.startGold > 0) bonusText += `<div class="bonus-item">+${townBonuses.startGold} Gold</div>`;
        if (townBonuses.towerDamage > 0) bonusText += `<div class="bonus-item">+${(townBonuses.towerDamage*100).toFixed(0)}% DMG</div>`;
        if (townBonuses.towerRange > 0) bonusText += `<div class="bonus-item">+${(townBonuses.towerRange*100).toFixed(0)}% RNG</div>`;
        bonusesEl.innerHTML = bonusText ? `<div class="bonuses-title">Town Bonuses:</div>${bonusText}` : '';
      }
    }

    function buildGrid() {
      const grid = document.getElementById('game-grid');
      grid.innerHTML = '';
      grid.style.gridTemplateColumns = `repeat(${GRID_SIZE}, var(--cell-size, ${CELL_SIZE}px))`;
      for (let y = 0; y < GRID_SIZE; y++) {
        for (let x = 0; x < GRID_SIZE; x++) {
          const cell = document.createElement('div');
          cell.className = 'grid-cell ' + (isOnPath(x, y) ? 'path' : 'empty');
          cell.dataset.x = x; cell.dataset.y = y;
          if (x === 0 && y === 5) cell.innerHTML = '<div class="spawn-marker">ENEMY</div>';
          if (x === 11 && y === 6) cell.innerHTML = '<div class="core-marker">üè∞</div>';
          cell.addEventListener('click', () => placeTower(x, y));
          cell.addEventListener('touchend', (e) => { e.preventDefault(); placeTower(x, y); });
          grid.appendChild(cell);
        }
      }
      ['enemies-layer', 'projectiles-layer', 'effects-layer'].forEach(id => { const layer = document.createElement('div'); layer.id = id; grid.appendChild(layer); });
    }

    function buildTowerButtons() {
      const container = document.getElementById('tower-buttons');
      container.innerHTML = '';
      Object.entries(TOWERS).forEach(([type, tower]) => {
        const unlocked = saveData.unlockedTowers.includes(type);
        const cost = Math.floor(tower.cost * (1 - townBonuses.towerDiscount));
        const btn = document.createElement('button');
        btn.id = `tower-btn-${type}`;
        btn.className = 'tower-button' + (!unlocked ? ' locked' : '');
        btn.innerHTML = `<div class="tower-button-header"><span class="tower-button-name" style="color:${tower.color}">${tower.name}</span>${unlocked ? `<span class="tower-button-cost">ü™ô${cost}</span>` : '<span class="tower-button-lock">üîí</span>'}</div>`;
        btn.addEventListener('click', () => unlocked && selectTowerType(type));
        container.appendChild(btn);
      });
    }

    function buildSkillsBar() {
      const container = document.getElementById('skills-bar');
      container.innerHTML = '';
      Object.entries(SKILLS).forEach(([key, skill]) => {
        const btn = document.createElement('button');
        btn.id = `skill-${key}`;
        btn.className = 'skill-button';
        btn.innerHTML = `<span>${skill.icon}</span><span class="skill-cooldown"></span><span class="skill-key">${skill.key}</span>`;
        btn.addEventListener('click', () => useSkill(key));
        container.appendChild(btn);
      });
    }

    document.addEventListener('keydown', (e) => {
      if (document.getElementById('game-screen').classList.contains('hidden')) return;
      const keys = { '1': 'fireball', '2': 'freeze', '3': 'gold', '4': 'heal' };
      if (keys[e.key]) useSkill(keys[e.key]);
    });

    function useSkill(key) {
      const skill = SKILLS[key];
      if (!skill || skillCooldowns[key] > Date.now()) return;
      skillCooldowns[key] = Date.now() + skill.cooldown;
      if (key === 'fireball') enemies.forEach(e => { if (e.spawned) e.health -= skill.damage; });
      else if (key === 'freeze') enemies.forEach(e => { if (e.spawned) e.frozenUntil = Date.now() + skill.duration; });
      else if (key === 'gold') credits += skill.amount;
      else if (key === 'heal') lives = Math.min(25 + townBonuses.startLives, lives + skill.amount);
      updateUI();
    }

    function selectTowerType(type) {
      selectedTower = selectedTower === type ? null : type;
      updateUI();
      document.querySelectorAll('.grid-cell.empty').forEach(cell => {
        cell.classList.toggle('can-place', selectedTower && !towers.some(t => t.x === +cell.dataset.x && t.y === +cell.dataset.y));
      });
    }

    function placeTower(x, y) {
      if (!selectedTower || isOnPath(x, y) || towers.some(t => t.x === x && t.y === y)) return;
      const cost = Math.floor(TOWERS[selectedTower].cost * (1 - townBonuses.towerDiscount));
      if (credits < cost) return;
      towers.push({ id: Date.now(), type: selectedTower, x, y, lastAttack: 0 });
      credits -= cost;
      selectedTower = null;
      renderTowers();
      updateUI();
    }

    function renderTowers() {
      document.querySelectorAll('.tower-3d, .tower-range').forEach(el => el.remove());
      towers.forEach(tower => {
        const cell = document.querySelector(`.grid-cell[data-x="${tower.x}"][data-y="${tower.y}"]`);
        if (!cell) return;
        const def = TOWERS[tower.type];
        const range = def.range * (1 + townBonuses.towerRange);
        const rangeEl = document.createElement('div');
        rangeEl.className = 'tower-range';
        rangeEl.style.width = rangeEl.style.height = `${range * CELL_SIZE * 2}px`;
        rangeEl.style.left = `${CELL_SIZE / 2 - range * CELL_SIZE}px`;
        rangeEl.style.top = `${CELL_SIZE / 2 - range * CELL_SIZE}px`;
        rangeEl.style.color = def.color;
        cell.appendChild(rangeEl);
        const wrapper = document.createElement('div');
        wrapper.innerHTML = TOWER_MODELS[tower.type];
        cell.appendChild(wrapper.firstElementChild);
      });
    }

    function generateWave(waveNum) {
      const baseCount = 5 + waveNum * 2;
      const newEnemies = [];
      let availableTypes = ['peasant', 'footman'];
      if (waveNum >= 2) availableTypes.push('archer');
      if (waveNum >= 3) availableTypes.push('knight', 'cavalry');
      if (waveNum >= 5) availableTypes.push('darkKnight', 'berserker');
      if (waveNum >= 7) availableTypes.push('warlock', 'siege');
      if (waveNum >= 10) availableTypes.push('champion');
      if (waveNum >= 12) availableTypes.push('necromancer');
      if (waveNum >= 14) availableTypes.push('dragon');
      if (waveNum % 5 === 0) {
        const bossTypes = availableTypes.filter(t => ENEMIES[t]?.type === 'boss');
        if (bossTypes.length > 0) {
          const bossType = bossTypes[Math.floor(Math.random() * bossTypes.length)];
          const def = ENEMIES[bossType];
          newEnemies.push({ id: Date.now(), type: bossType, health: def.health * (1 + waveNum * 0.1), maxHealth: def.health * (1 + waveNum * 0.1), speed: def.speed, progress: 0, spawnDelay: 0, spawned: false, slowedUntil: 0, frozenUntil: 0, burningUntil: 0, poisonedUntil: 0, reward: def.reward, armor: def.armor || 0, shield: def.shield || 0 });
        }
      }
      for (let i = 0; i < baseCount; i++) {
        const weights = availableTypes.map(t => ENEMIES[t]?.type === 'boss' ? 0.02 : ENEMIES[t]?.type === 'elite' ? 0.1 : 0.88);
        const totalWeight = weights.reduce((a, b) => a + b, 0);
        let rand = Math.random() * totalWeight;
        let type = availableTypes[0];
        for (let j = 0; j < availableTypes.length; j++) { rand -= weights[j]; if (rand <= 0) { type = availableTypes[j]; break; } }
        const def = ENEMIES[type];
        newEnemies.push({ id: Date.now() + i + 1, type, health: def.health * (1 + waveNum * 0.08), maxHealth: def.health * (1 + waveNum * 0.08), speed: def.speed, progress: 0, spawnDelay: (i + 1) * 500, spawned: false, slowedUntil: 0, frozenUntil: 0, burningUntil: 0, poisonedUntil: 0, reward: def.reward, armor: def.armor || 0, shield: def.shield || 0 });
      }
      return newEnemies;
    }

    function startWave() { if (waveInProgress) return; enemies = generateWave(wave); waveInProgress = true; updateUI(); }

    function renderEnemies() {
      const layer = document.getElementById('enemies-layer');
      layer.innerHTML = '';
      enemies.filter(e => e.spawned).forEach(enemy => {
        const pos = getPositionOnPath(enemy.progress);
        const hp = enemy.health / enemy.maxHealth;
        const def = ENEMIES[enemy.type];
        const el = document.createElement('div');
        el.className = 'enemy-3d';
        if (enemy.slowedUntil > Date.now()) el.classList.add('slowed');
        if (enemy.frozenUntil > Date.now()) el.classList.add('frozen');
        if (enemy.burningUntil > Date.now()) el.classList.add('burning');
        el.style.left = `${pos.x * CELL_SIZE + CELL_SIZE / 2}px`;
        el.style.top = `${pos.y * CELL_SIZE + CELL_SIZE / 2}px`;
        el.innerHTML = `<div class="enemy-model">${def.icon}</div><div class="enemy-health-bar"><div class="enemy-health-fill" style="width:${hp * 100}%;background:${hp > 0.5 ? '#22c55e' : hp > 0.25 ? '#eab308' : '#ef4444'}"></div></div>`;
        layer.appendChild(el);
      });
    }

    function renderProjectiles() {
      const layer = document.getElementById('projectiles-layer');
      layer.innerHTML = '';
      projectiles.forEach(proj => {
        const t = Math.min((Date.now() - proj.created) / 100, 1);
        const x = proj.startX + (proj.endX - proj.startX) * t, y = proj.startY + (proj.endY - proj.startY) * t;
        const el = document.createElement('div');
        el.className = 'projectile';
        el.style.cssText = `left:${x}px;top:${y}px;width:${proj.size || 6}px;height:${proj.size || 6}px;background:radial-gradient(circle,white,${proj.color});box-shadow:0 0 8px ${proj.color}`;
        layer.appendChild(el);
      });
    }

    function renderEffects() {
      const layer = document.getElementById('effects-layer');
      layer.innerHTML = '';
      effects.forEach(effect => {
        const age = Date.now() - effect.created;
        const el = document.createElement('div');
        el.className = 'effect';
        el.style.cssText = `left:${effect.x}px;top:${effect.y - age / 10}px;opacity:${1 - age / 500}`;
        el.textContent = effect.type === 'kill' ? 'üíÄ' : `+${effect.amount}`;
        layer.appendChild(el);
      });
    }

    function addEffect(type, x, y, amount = 0) { effects.push({ id: Date.now(), type, x, y, created: Date.now(), amount }); }

    function applyDamage(enemy, damage) {
      if (enemy.shield > 0) { const absorbed = Math.min(enemy.shield, damage); enemy.shield -= absorbed; damage -= absorbed; }
      const dmg = damage * (1 + townBonuses.towerDamage) * (1 - (enemy.armor || 0));
      enemy.health -= dmg;
      return enemy.health <= 0;
    }

    function handleKill(enemy, pos) {
      const reward = Math.floor(enemy.reward * (1 + townBonuses.goldPerKill));
      credits += reward;
      score += enemy.reward * 10;
      kills++;
      addEffect('kill', pos.x * CELL_SIZE + CELL_SIZE / 2, pos.y * CELL_SIZE + CELL_SIZE / 2);
      addEffect('gold', pos.x * CELL_SIZE + CELL_SIZE / 2, pos.y * CELL_SIZE + CELL_SIZE / 2 - 15, reward);
    }

    function gameLoop() {
      const now = Date.now();
      const delta = now - lastUpdate;
      lastUpdate = now;
      enemies = enemies.map(e => {
        if (!e.spawned) return e.spawnDelay <= 0 ? { ...e, spawned: true } : { ...e, spawnDelay: e.spawnDelay - delta };
        if (e.frozenUntil > now) return e;
        if (e.burningUntil > now) e.health -= 5 * delta / 1000;
        if (e.poisonedUntil > now) e.health -= 4 * delta / 1000;
        const speedMod = e.slowedUntil > now ? 0.5 : 1;
        return { ...e, progress: e.progress + (e.speed * speedMod * delta) / 10000 };
      });
      const reached = enemies.filter(e => e.progress >= 1 && e.spawned);
      if (reached.length) {
        lives -= reached.reduce((s, e) => s + (ENEMIES[e.type]?.type === 'boss' ? 3 : ENEMIES[e.type]?.type === 'elite' ? 2 : 1), 0);
        enemies = enemies.filter(e => e.progress < 1);
        if (lives <= 0) { gameOver(false); return; }
      }
      towers = towers.map(tower => {
        const def = TOWERS[tower.type];
        if (now - tower.lastAttack < def.attackSpeed) return tower;
        const range = def.range * (1 + townBonuses.towerRange);
        const inRange = enemies.filter(e => e.spawned && e.health > 0 && distance(tower.x, tower.y, getPositionOnPath(e.progress).x, getPositionOnPath(e.progress).y) <= range);
        if (!inRange.length) return tower;
        const target = inRange[0];
        const targetPos = getPositionOnPath(target.progress);
        projectiles.push({ id: Date.now(), startX: tower.x * CELL_SIZE + CELL_SIZE / 2, startY: tower.y * CELL_SIZE + CELL_SIZE / 2, endX: targetPos.x * CELL_SIZE + CELL_SIZE / 2, endY: targetPos.y * CELL_SIZE + CELL_SIZE / 2, color: def.color, size: def.aoe ? 10 : 6, created: Date.now() });
        if (def.aoe) {
          enemies.forEach(e => {
            if (!e.spawned) return;
            const pos = getPositionOnPath(e.progress);
            if (distance(tower.x, tower.y, pos.x, pos.y) <= (def.aoeRadius || range)) {
              if (def.burn) e.burningUntil = now + def.burn.duration;
              if (applyDamage(e, def.damage)) handleKill(e, pos);
            }
          });
        } else if (def.chain) {
          let targets = [target], rem = def.chain - 1;
          while (rem-- > 0) {
            const last = targets[targets.length - 1];
            const lastPos = getPositionOnPath(last.progress);
            const next = inRange.find(e => !targets.includes(e) && distance(lastPos.x, lastPos.y, getPositionOnPath(e.progress).x, getPositionOnPath(e.progress).y) <= 2);
            if (next) targets.push(next);
          }
          targets.forEach(e => { if (applyDamage(e, def.damage)) handleKill(e, getPositionOnPath(e.progress)); });
        } else {
          if (def.slow) target.slowedUntil = now + 1500;
          if (def.poison) target.poisonedUntil = now + def.poison.duration;
          if (applyDamage(target, def.damage)) handleKill(target, targetPos);
        }
        return { ...tower, lastAttack: now };
      });
      enemies = enemies.filter(e => e.health > 0 || !e.spawned);
      projectiles = projectiles.filter(p => Date.now() - p.created < 120);
      effects = effects.filter(e => Date.now() - e.created < 500);
      if (waveInProgress && !enemies.length) {
        waveInProgress = false;
        wave++;
        credits += 35 + wave * 12 + townBonuses.waveBonus;
        if (wave > MAX_WAVES) { gameOver(true); return; }
      }
      renderEnemies();
      renderProjectiles();
      renderEffects();
      updateUI();
    }

    function gameOver(won) {
      clearInterval(gameLoopId);
      const goldReward = Math.floor(score / 15) + (won ? 300 : 50);
      const gemReward = won ? Math.floor(wave / 3) : 0;
      saveData.gold += goldReward;
      saveData.gems += gemReward;
      saveData.xp += score;
      if (saveData.xp >= saveData.level * 1000) { saveData.level++; saveData.xp = 0; }
      saveData.gamesPlayed++;
      saveToDisk();
      document.getElementById('game-screen').classList.add('hidden');
      document.getElementById('game-over-screen').classList.remove('hidden');
      document.getElementById('game-over-title').textContent = won ? 'VICTORY!' : 'DEFEAT';
      document.getElementById('game-over-title').className = 'game-over-title ' + (won ? 'won' : 'lost');
      document.getElementById('game-over-score').textContent = `Score: ${score.toLocaleString()}`;
      document.getElementById('game-over-stats').textContent = `Wave ${wave} | Kills: ${kills}`;
      document.getElementById('game-over-reward').textContent = `+${goldReward} Gold${gemReward > 0 ? `, +${gemReward} Gems` : ''}`;
    }

    function startGame() {
      document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
      document.getElementById('game-screen').classList.remove('hidden');
      initGame();
      buildGrid();
      buildTowerButtons();
      buildSkillsBar();
      updateUI();
      lastUpdate = Date.now();
      gameLoopId = setInterval(gameLoop, TICK_RATE);
    }

    function resetGame() {
      document.getElementById('game-over-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');
      initGame();
      buildGrid();
      buildTowerButtons();
      buildSkillsBar();
      updateUI();
      lastUpdate = Date.now();
      gameLoopId = setInterval(gameLoop, TICK_RATE);
    }

    function quitGame() { clearInterval(gameLoopId); showMenu(); }
    function backToMenu() { showMenu(); }

    // ============== INIT ==============
    window.addEventListener('resize', () => { if (!document.getElementById('game-screen').classList.contains('hidden')) { updateCellSize(); buildGrid(); renderTowers(); } });
    loadSave();
    updateMenuDisplay();

    // ============== PWA ==============
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(() => {}); }
  </script>
</body>
</html>
